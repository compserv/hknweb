{% extends "base.html" %}
{% load static %}

{% block title %}Tutoring{% endblock %}
{% block heading %}Tutoring{% endblock %}

{% block header %}
    <link rel="stylesheet" href="https://unpkg.com/@fullcalendar/core@4.4.0/main.css" />
    <link rel="stylesheet" href="https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.css" />
    <link rel="stylesheet" href="https://unpkg.com/@fullcalendar/timegrid@4.4.0/main.css" />

    <script src="https://unpkg.com/@fullcalendar/core@4.4.0/main.js"></script>
    <script src="https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.js"></script>
    <script src="https://unpkg.com/@fullcalendar/timegrid@4.4.0/main.js"></script>

    {% include 'events/_nav_buttons.html' %}

    <style>
        a.fc-event{
            width: 15em;
        }

        .tooltip {
            color: black;
            background-color: WhiteSmoke;
            width: 200%;
            border-radius: 0.15em;
            min-height: 3em;
            padding: 0;
            position: relative;
            top: calc(-75% - 1px);
            left: -1px;
            z-index: 10;
            display: none;
        }

        .tooltip-title {
            text-align: center;
            margin-bottom: 0.5em;
            color: white;
            font-size: 125%;
            border-radius: inherit;
        }

        .tooltip-body {
            margin-left: 0.5em;
            margin-right: 0.5em;
        }

        .tooltip-tutor-img {
            display: inline-block;
            margin-right: 0.5em;
            width: 12em;
            height: 12em;
        }

        .tooltip-tutor-desc {
            display: inline-block;
            width: 15em;
            vertical-align: top;
        }
    </style>

    <script type="text/javascript">
        var course_selector_decorator;

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                // General options
                plugins: [ 'timeGrid' ],
                defaultView: 'timeGridDay',
                defaultDate: '{{ offset|date:"c" }}',
                header: {
                    left: 'prev,next',
                    center: 'title',
                    right: 'today',
                },
                height: "auto",
                eventMaxStack: 1,
                allDaySlot: false,
                navLinks: true,
                eventLimit: false,
                views: {
                    timeGrid: {
                        minTime: "10:00:00",
                        maxTime: "22:00:00",
                        nowIndicator: true,
                    }
                },
                eventSources: [
                    {
                        url: '{% url "tutoring:slots" %}',
                        extraParams: function () {
                            var course_select = document.getElementById("id_course");
                            if (!course_select.nextElementSibling) {
                                return {};
                            }

                            var text_id_mapping = {};
                            var course_options = course_select.options;
                            for (let i = 0; i < course_options.length; i++) {
                                text_id_mapping[course_options[i].text] = course_options[i].value;
                            }

                            var course_choices = course_select.nextElementSibling.getElementsByTagName("li");
                            var course_choice_ids = [];
                            for (let i = 0; i < course_choices.length - 1; i++) {
                                course_choice_ids.push(text_id_mapping[course_choices[i].title]);
                            }
                            return {
                                course_filter: course_choice_ids.join(",")
                            }
                        }
                    }
                ],
                eventRender: function (eventRenderInfo) {
                    var tooltip = document.createElement("div");
                    tooltip.id = eventRenderInfo.event.id + "tooltip";
                    tooltip.classList.add("tooltip");

                    var tooltip_title = document.createElement("div");
                    tooltip.append(tooltip_title);
                    tooltip_title.classList.add("tooltip-title");
                    tooltip_title.style.backgroundColor = eventRenderInfo.event.backgroundColor;
                    tooltip_title.append(eventRenderInfo.event.extendedProps.tooltip_title);

                    var tooltip_body = document.createElement("div");
                    tooltip.append(tooltip_body);
                    tooltip_body.classList.add("tooltip-body");

                    eventRenderInfo.event.extendedProps.tutors.forEach(t => {
                        var tutor_img = document.createElement("img");
                        tutor_img.classList.add("tooltip-tutor-img");
                        tutor_img.src = t.picture;
                        tutor_img.alt = t.alt;

                        var tutor_desc = document.createElement("div");
                        tutor_desc.classList.add("tooltip-tutor-desc");

                        var tutor_name = document.createElement("div");
                        tutor_name.style.fontWeight = "bold";
                        tutor_name.append(t.name);

                        tutor_desc.append(tutor_name);
                        tutor_desc.append("Courses: " + t.courses);

                        tooltip_body.append(tutor_img);
                        tooltip_body.append(tutor_desc);
                    });

                    eventRenderInfo.el.append(tooltip);
                },
                eventMouseEnter: function (mouseEnterInfo) {
                    document.getElementsByClassName("fc-time-grid-container")[0].style.overflow = "visible";

                    document.getElementById(mouseEnterInfo.event.id + "tooltip").style.display = "block";
                    mouseEnterInfo.el.style.zIndex = 10;
                },
                eventMouseLeave: function (mouseLeaveInfo) {
                    document.getElementById(mouseLeaveInfo.event.id + "tooltip").style.display = "none";
                    mouseLeaveInfo.el.style.zIndex = 1;
                }
            });

            calendar.render();

            course_selector_decorator = function () {
                calendar.refetchEvents();
            }
        });

        window.addEventListener("load", function () {
            decorate_nav_buttons();
        });

    </script>
{% endblock %}

{% block content %}
    <div style="text-align: center; overflow: auto;">
        <div style="width: 30em; margin: auto; display: inline-block;">
            <section id="calendar"></section>
        </div>

        <div style="display: inline-block; text-align: center; margin-left: 1em;">
            Filter by courses
            <br>
            {{ form.course }}
        </div>
    </div>
{% endblock %}
